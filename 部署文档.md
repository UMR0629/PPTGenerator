# 部署文档
本文档介绍了pdf2ppt的部署方式，包括容器部署和开发环境部署。
## 容器部署
### 预下载部署（推荐）
由于网络原因，一些部件的下载过于缓慢，因此建议手动下载资源，放入仓库中后再进行部署。
下载detecron2的压缩文件放入仓库根目录下，下载链接：

https://github.com/facebookresearch/detectron2/archive/refs/heads/main.zip

下载layoutparser的预训练模型的PubLayNet，选择faster_rcnn_R_50_FPN_3x版本，放入仓库的pdf_scan目录下，并命名为model_final.pth，下载链接：

https://www.dropbox.com/s/dgy9c10wykk4lq4/model_final.pth?dl=1

该链接也可在pdf_scan目录下的config.yaml文件中找到。

下载完成后，在仓库根目录下，执行以下命令：

```bash
docker build -t pdf2ppt .
```
使用以下命令启动：
```bash
docker run -it  --network host --name pdf-container pdf2ppt /bin/bash
```
进入容器后，应当处于root@pdf-container:/app$，执行以下命令：
```bash
streamlit run newpage.py
```
即可启动服务。服务占用8501端口，可通过浏览器访问http://localhost:8501/ 进行访问。

### 自动化部署
如果网络条件允许，可以尝试自动化部署。

- detectron的安装
修改Dockerfile如下：
```Dockerfile
# 修改以下内容
# # 安装detectron2（增加详细日志）
# RUN cd /tmp && \
#     unzip detectron2-main.zip && \
#     cd detectron2-main && \  
#     pip install -v . && \
#     rm -rf /tmp/detectron2-main*
RUN pip install "git+https://github.com/facebookresearch/detectron2.git"

```
- layoutparser模型的安装
修改./pdf_scan/scan_pdf.py文件，在30行附近，修改代码：
```python
#修改以下部分
# # 构建绝对路径
# config_path = current_directory / "config.yml"
# model_path = current_directory / "model_final.pth"

# 替换配置路径为layoutparser内置的配置文件路径
config_path="lp://PubLayNet/faster_rcnn_R_50_FPN_3x/config"
#注释掉model_path的设置
# 加载模型
model = lp.Detectron2LayoutModel(
    config_path=str(config_path),
    # model_path=str(model_path), 注释掉这行
    label_map={0: "Text", 1: "Title", 2: "List", 3: "Table", 4: "Figure"},
    extra_config=["MODEL.ROI_HEADS.SCORE_THRESH_TEST", 0.8]
)
```
这样将实现完全自动下载的环境配置和部署，但我们并不推荐这么做。也可以切换到auto_deploy分支，运行：
```bash
git checkout auto_deploy
docker build -t pdf2ppt .
```
来完成docker环境的构建。

## 开发环境部署
这一节旨在为后续的开发者提供在非容器化的场景下部署的指导。

### python环境
建议使用anaconda或miniconda创建python环境，并安装以下依赖：
```
pip install -r requirements.txt
```

### 其他程序依赖

- 下载并安装detectron2
对于Linux系统，detectron2的安装：
```
pip install "git+https://github.com/facebookresearch/detectron2.git"
```
对于Windows系统，如果运行时出现以下报错
```
AttributeError: module layoutparser has no attribute Detectron2LayoutModel
```
则需要额外安装detectron2在Windows系统上的修复：
```
pip install "git+https://github.com/ivanpp/detectron2.git"
```

- poppler
对于Linux系统，poppler的安装：
```
sudo apt-get install poppler-utils
```

对于Windows系统，可以从以下链接下载安装：
https://github.com/oschwartz10612/poppler-windows/releases/tag/v24.08.0-0

下载完成后，需要配置环境变量，将bin目录添加到PATH中。

- tesseract
对于Linux系统，tesseract的安装：
```
sudo apt-get install -y \
    tesseract-ocr \
    tesseract-ocr-chi-sim \
    tesseract-ocr-eng
```

对于Windows系统，可以从以下链接下载安装：
https://github.com/tesseract-ocr/tesseract/tree/5.5.0
请参照官方文档安装。

安装完成后，需要配置环境变量，将tesseract.exe目录添加到PATH中，并且在根目录下./pdf_scan/scan_pdf.py文件中，修改以下代码中tesseract的路径为实际的路径：
```python
# 设置Tesseract路径
if platform.system() == "Windows":
    pytesseract.pytesseract.tesseract_cmd = "C:\\Program Files\\Tesseract-OCR\\tesseract.exe"
else:  
    pytesseract.pytesseract.tesseract_cmd = "/usr/bin/tesseract"
```